import logging
import asyncio
from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import ReplyKeyboardRemove, ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, \
    InlineKeyboardButton
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters import Command
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher.filters.state import StatesGroup, State

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è —Å —Ç–æ–∫–µ–Ω–æ–º
import config
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
import keyboard
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è —Å —ç–º–æ–¥–∂–∏
import emoji

# –°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
storage = MemoryStorage()
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∂–∏–º–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ (–¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º  parse_mode)
bot = Bot(config.TOKEN, parse_mode=types.ParseMode.HTML)
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ (Dispatcher - –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—Å–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç),  —É–∫–∞–∑—ã–≤–∞–µ–º –µ–º—É –Ω–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
dp = Dispatcher(bot, storage=storage)
# –ü–æ–¥–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    # –£–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å –ª–æ–≥–∞–º–∏
    filename='log.txt',
    # –£–∫–∞–∑—ã–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    level=logging.INFO,
    # –£–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤
    format=u'%(filename)s [LINE:%(lineno)d] #%(levelname)-8s '
           u'[%(asctime)s] %(message)s')


# –ó–∞–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã start
@dp.message_handler(commands='start', state=None)
async def welcome(message: types.Message):
    # J—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª user.txt –≤ —Ä–µ–∂–∏–º–µ —á—Ç–µ–Ω–∏—è
    joined_file = open('user.txt', 'r')
    # C–æ–∑–¥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–º–µ–Ω –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ txt
    joined_users = set()
    # G—Ä–æ—Ö–æ–¥–∏–º —Ü–∏–∫–ª–æ–º –ø–æ –∫–∞–∂–¥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ user.txt
    for line in joined_file:
        # –î–æ–±–∞–≤–ª—è–µ–º user_id –≤ –Ω–∞—à–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        joined_users.add(line.strip())
    # E—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∂–∞–ª /start, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if not str(message.chat.id) in joined_users:
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª user.txt –Ω–∞ –¥–æ–∑–∞–ø–∏—Å—å
        joined_file = open('user.txt', 'a')
        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –Ω–µ–≥–æ id –Ω–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        joined_file.write(str(message.chat.id) + '\n')
        # –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        joined_users.add(message.chat.id)
        # –ì–æ–≤–æ—Ä–∏–º –±–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–∏ —ç—Ç–æ–º
    await bot.send_message(
        # –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        message.chat.id,
        # –£–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ hello + –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        f'‚úãHello {message.from_user.first_name}',
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞ keyboard, –æ–±—Ä–∞—Ç–∏–≤—à–∏—Å—å –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π start
        reply_markup=keyboard.start)


# –ó–∞–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —É–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞–∫ text
@dp.message_handler(content_types=['text'])
# –ó–∞–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫
async def info_static(message: types.Message):
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µüåè'
    if message.text == '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µüåè':
        # –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ –µ–≥–æ
        await bot.send_message(message.chat.id,
                               # —Å —Ç–µ–∫—Å—Ç–æ–º
                               text='–ë–æ—Ç \n—Å–æ–∑–¥–∞–Ω –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö üöÄ ?',
                               # —Ä–µ–∂–∏–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                               parse_mode='Markdown')
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ = '–•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ?'
    elif message.text == '–•–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ?':
        # –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ –µ–≥–æ
        await message.answer('–ü–æ–¥–µ–ª—é—Å—å –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π' + emoji.emojize(":brain:"),
                             reply_markup=keyboard.offer_add_info)
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ = '–û–±—É—á–µ–Ω–∏–µ'
    elif message.text == '–û–±—É—á–µ–Ω–∏–µ':
        # –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ –µ–≥–æ
        await message.answer('–ü–æ–¥–µ–ª—é—Å—å –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π' + emoji.emojize(":brain:"),
                             reply_markup=keyboard.offer_add_info)


# –ó–∞–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ inline - –æ–∂–∏–¥–∞–µ–º –∫–æ–ª–±—ç–∫ –∏ –ø—Ä–∏–Ω–∏–º–∞–µ–º lambda-—Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ–ª–±—ç–∫–∞
@dp.callback_query_handler(lambda c: True)
# –ó–∞–¥–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –æ—Ç–ª–∞–≤–ª–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –Ω–∞–º –∫–æ–ª–±—ç–∫
async def callback_inline(call):
    # –ï—Å–ª–∏ –∫–æ–ª–±—ç–∫ "www" - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —é–∑–µ—Ä—É —Å–æ–æ–±—â–µ–Ω–∏–µ
    if call.data == "www":
        # –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ –µ–≥–æ
        await bot.send_message(call.message.chat.id,
                               '–ü–æ–Ω—è—Ç–Ω–æ üòá \nE—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—É—á–µ–Ω–∏—é - –ø—Ä–∏—à–ª–∏ –º–Ω–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç "–û–±—É—á–µ–Ω–∏–µ" ')


# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
if __name__ == '__main__':
    executor.start_polling(dp)

# –ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏ - –≤—ã–∑–æ–≤ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã
# @dp.message_handler(commands=['1'])
# async def url_command(message: types.Message):
#     await bot.send_message(
#         message.chat.id,
#         text='–°—Å—ã–ª–æ—á–∫–∞',
#         reply_markup=keyboard.stats)
